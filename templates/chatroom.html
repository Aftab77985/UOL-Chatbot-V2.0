{% extends 'base.html' %}
{% load static %}
{% block title %}Chat Room{% endblock %}
{% block content %}
<div class="col-md-6 text-center">
    <img src="{%static 'images/home2.png'%}" class="img-fluid">
</div>
<div class="col-md-6 " >
    <p class="promo-title">UOL CHATBOT</p>
<p>
    The university requires a system that can provide quick and accurate responses to userâ€™s
specific questions from university officials. We believe developing an application
that can handle user questions automatically by understanding the intent of the question is
the best way to resolve the problem.<br> <b>PLEASE CLICK ON THE ICON BELOW TO GET STARTED</b>
</p>
<style>
    .rw-conversation-container .rw-header{background-color:hsl(250, 69%, 61%);}
    .rw-conversation-container .rw-messages-container .rw-message .rw-client{background-color: hsl(250, 69%, 61%);}
    .rw-launcher{background-color: hsl(250, 69%, 61%);}
</style>

<script>!(function () {
    let e = document.createElement("script"),
      t = document.head || document.getElementsByTagName("head")[0];
    (e.src =
      "https://cdn.jsdelivr.net/npm/rasa-webchat@1.x.x/lib/index.js"),
      // Replace 1.x.x with the version that you want
      (e.async = !0),
      (e.onload = () => {
        window.WebChat.default(
          {
            customData: { language: "en" },
            
            socketUrl: "https://rasa-server-aftab77985.cloud.okteto.net",
            title: 'UOL ChatBot',
            subtitle: '',
            showFullScreenButton: true,
            showMessageDate: true,
            hideWhenNotConnected: false,
            params: {
                storage: 'session'
            },
            
            
          },
          null
        );
      }),
      t.insertBefore(e, t.firstChild);
  })();
  </script>
</div>

<!-- <header class="header">
  <p class="title">Chat with UOL chatbot</p>
</header>
<div id="messages"></div>
<form id="form">
  <input id="message-input" autocomplete="off" autofocus/>
  <button class="button">Send</button>
</form>
<script>
    // Connect to RASA server
    const socket = io("http://localhost:5005");
    
    const messages = document.getElementById('messages');
    const form = document.getElementById('form');
    const messageInput = document.getElementById('message-input');

    function scrollToBottom() {
        window.scrollTo(0, document.body.scrollHeight);
    }

    function appendMessage(msg, type) {
        const item = document.createElement('div');
        item.textContent = msg;
        item.classList.add("message");
        item.classList.add(`message_${type}`);
        messages.appendChild(item);
        scrollToBottom();
    }

    function appendImage(src, type) {
        const item = document.createElement('div');
        item.classList.add("message");
        item.classList.add(`message_${type}`);
        const img = document.createElement('img');
        img.src = src;
        img.onload = scrollToBottom;
        item.appendChild(img);
        messages.appendChild(item);
    }

    function appendQuickReplies(quickReplies) {
        const quickRepliesNode = document.createElement('div');
        quickRepliesNode.classList.add("quick-replies");
        quickReplies.forEach(quickReply => {
            const quickReplyDiv = document.createElement('button');
            quickReplyDiv.innerHTML = quickReply.title;
            quickReplyDiv.classList.add("button");
            quickReplyDiv.addEventListener("click", () => {
                messages.removeChild(quickRepliesNode);
                appendMessage(quickReply.title, "sent");
                socket.emit('user_uttered', {
                    "message": quickReply.payload,
                });
            })
            quickRepliesNode.appendChild(quickReplyDiv);
        })
        messages.appendChild(quickRepliesNode);
        scrollToBottom();
    }

    form.addEventListener('submit', function (e) {
        e.preventDefault();
        const msg = messageInput.value;
        if (msg) {
            socket.emit('user_uttered', {
                "message": msg,
            });
            messageInput.value = '';

            appendMessage(msg, "sent");
        }
    });

    socket.on('connect', function () {
        console.log("Connected to Socket.io server");
    });

    socket.on('connect_error', (error) => {
        // Write any connection errors to the console 
        console.error(error);
    });

    socket.on('bot_uttered', function (response) {
        console.log("Bot uttered:", response);
        if (response.text) {
            appendMessage(response.text, "received");
        }
        if (response.attachment) {
            appendImage(response.attachment.payload.src, "received");
        }
        if (response.quick_replies) {
            appendQuickReplies(response.quick_replies);
        }
    });
</script> -->
{% endblock %}